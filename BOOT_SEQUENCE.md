# Boot Sequence and Configuration Management

## Overview
RaCore now includes an advanced boot sequence that performs automatic health checks, configuration verification, and self-healing on every startup.

## Boot Sequence Features

### 1. Self-Healing Health Checks
On every startup, RaCore:
- Runs health checks on all loaded modules
- Identifies healthy, degraded, and unhealthy modules
- Automatically attempts recovery for degraded/unhealthy modules
- Reports results to the console

**Example Output:**
```
[BootSequence] Step 1/3: Running self-healing health checks...
✅ Health check complete:
   Healthy: 34
   ⚠️  Degraded: 1
[BootSequence] Attempting auto-recovery...
   AILanguage: ✅ Recovered
```

### 2. Apache Configuration Management

#### Automatic Configuration on Boot
**NEW:** RaCore now automatically configures Apache reverse proxy during boot sequence when Apache is detected!

On every startup, RaCore:
- Detects Apache installation (Windows, Linux, macOS)
- Locates httpd.conf configuration file
- Checks if RaCore reverse proxy is already configured
- **Automatically configures reverse proxy** if not present
- **Automatically includes ServerAlias for agpstudios.online and www.agpstudios.online**
- Creates backup of httpd.conf before modifications
- Reports detailed status and instructions

**No environment variables required!** Simply launch RaOS.exe and Apache will be configured automatically to accept traffic from localhost, agpstudios.online, and www.agpstudios.online.

#### How It Works
1. **Apache Detection**: Boot sequence finds Apache executable and config file
2. **Configuration Check**: Verifies if RaCore reverse proxy is already set up
3. **Auto-Configuration**: If not configured:
   - Enables mod_proxy and mod_proxy_http modules
   - Adds VirtualHost configuration for port 80
   - Adds ServerAlias for agpstudios.online and www.agpstudios.online
   - Creates timestamped backup of httpd.conf
   - **Automatically restarts Apache** to apply changes
4. **Immediate Access**: After automatic restart, access RaCore at:
   - http://localhost
   - http://agpstudios.online
   - http://www.agpstudios.online

#### Customization (Optional)
You can customize the domain using environment variables:
- `RACORE_PORT=5000` - RaCore server port (default: 5000)
- `RACORE_PROXY_DOMAIN=yourdomain.com` - Custom domain (default: localhost)

**Example (Windows):**
```batch
set RACORE_PROXY_DOMAIN=example.com
RaOS.exe
```

**Example (Linux/macOS):**
```bash
export RACORE_PROXY_DOMAIN=example.com
./RaCore
```

#### Reverse Proxy Configuration (Windows)
Apache 2.4 reverse proxy configuration for RaCore:

**Features:**
- Auto-detects Apache installation path on Windows (C:\Apache, E:\Apache, etc.)
- Finds httpd.conf configuration file automatically
- Enables mod_proxy and mod_proxy_http modules
- Adds reverse proxy VirtualHost configuration
- Supports WebSocket proxying for /ws endpoint
- Creates automatic backup before modifying config
- Supports custom domains and ports
- **Detailed error reporting** with troubleshooting steps

**Generated Configuration:**
```apache
# RaCore Reverse Proxy Configuration
# Auto-generated by RaCore ApacheManager on 2024-01-01 12:00:00 UTC
# This configuration allows accessing RaCore at http://localhost (port 80)
# instead of http://localhost:5000
<VirtualHost *:80>
    ServerName localhost
    ServerAlias agpstudios.online www.agpstudios.online
    
    ProxyPreserveHost On
    ProxyPass / http://localhost:5000/
    ProxyPassReverse / http://localhost:5000/
    
    # WebSocket support
    ProxyPass /ws ws://localhost:5000/ws
    ProxyPassReverse /ws ws://localhost:5000/ws
    
    ErrorLog "logs/racore_proxy_error.log"
    CustomLog "logs/racore_proxy_access.log" combined
</VirtualHost>
```

#### Using the Configuration
After automatic configuration, **Apache is restarted automatically by RaOS**. No manual intervention needed!

If automatic restart fails (e.g., due to permissions), manually restart Apache:
- **Windows**: Open Services, find "Apache2.4", click Restart
  - Or run: `httpd.exe -k restart` in Apache bin directory
- **Linux**: `sudo systemctl restart apache2`
- **macOS**: `sudo apachectl restart`

After restart (automatic or manual), access RaCore at:
- **Standard URL**: http://localhost (port 80)
- **Production domain**: http://agpstudios.online (port 80)
- **www subdomain**: http://www.agpstudios.online (port 80)
- **Direct access**: http://localhost:5000 (always works)

#### Troubleshooting
If automatic configuration fails:
1. **Permission denied**: Run RaCore as Administrator (Windows) or with sudo (Linux/macOS)
2. **Apache not found**: Install Apache 2.4+ and ensure it's in PATH
3. **Config file not found**: Check Apache installation directory
4. **Manual configuration**: See error message for manual config steps
5. **Restart failed**: Manually restart Apache using commands above

### 3. PHP Configuration Management

#### Detection and Verification
RaCore automatically detects PHP installation:
- Searches common installation paths (C:\php, E:\php, /usr/bin/php, etc.)
- Verifies PHP version (PHP 8+ recommended)
- Locates php.ini configuration file
- Reports status on every boot

#### Static Methods Available

**Find PHP Executable:**
```csharp
string? phpPath = ApacheManager.FindPhpExecutable();
if (phpPath != null)
{
    Console.WriteLine($"PHP found at: {phpPath}");
}
```

**Find php.ini Configuration:**
```csharp
string? phpIniPath = ApacheManager.FindPhpIniPath();
if (phpIniPath != null)
{
    Console.WriteLine($"PHP config at: {phpIniPath}");
}
```

**Generate php.ini:**
```csharp
bool success = ApacheManager.GeneratePhpIni("/path/to/php.ini");
```

Generated php.ini includes:
- Recommended PHP settings for RaCore
- Error logging configuration
- Upload and post size limits
- SQLite3 support
- UTC timezone
- Security settings

## Boot Sequence Flow

```
1. Module Loading
   ↓
2. Boot Sequence Execution
   ├─ Self-Healing Health Checks
   │  ├─ Check all modules
   │  ├─ Identify issues
   │  └─ Attempt auto-recovery
   ├─ Apache Configuration Verification & Auto-Config
   │  ├─ Detect Apache
   │  ├─ Find httpd.conf
   │  ├─ Check if RaCore proxy configured
   │  └─ Auto-configure if needed (Windows)
   └─ PHP Configuration Verification
      ├─ Detect PHP
      ├─ Get version
      └─ Find php.ini
   ↓
3. First Run Check (if needed)
   ├─ Generate wwwroot files
   ├─ Spawn CMS
   └─ Configure Apache for CMS
   ↓
4. Server Startup
```

## Configuration API

### Environment Variables

**Apache Reverse Proxy Configuration:**
Apache reverse proxy is **now automatically configured** during boot sequence when Apache is detected!

**Optional customization** (environment variables):
- `RACORE_PROXY_DOMAIN=yourdomain.com` - Set custom domain (default: localhost)
- `RACORE_PORT=5000` - RaCore server port (default: 5000)

**Deprecated:**
- ~~`RACORE_CONFIGURE_APACHE_PROXY=true`~~ - No longer needed! Configuration is now automatic.

**Example (Windows):**
```batch
set RACORE_PROXY_DOMAIN=example.com
set RACORE_PORT=5000
RaOS.exe
```

**Example (Linux/macOS):**
```bash
export RACORE_PROXY_DOMAIN=example.com
export RACORE_PORT=5000
./RaCore
```

### Apache Configuration
```csharp
// Find Apache
string? apachePath = ApacheManager.FindApacheExecutable();
string? configPath = ApacheManager.FindApacheConfigPath();

// Configure reverse proxy
var manager = new ApacheManager("/cms/path", 8080);
bool success = manager.ConfigureReverseProxy(5000, "example.com");
```

### PHP Configuration
```csharp
// Find PHP
string? phpPath = ApacheManager.FindPhpExecutable();
string? phpIni = ApacheManager.FindPhpIniPath(phpPath);

// Generate php.ini
bool success = ApacheManager.GeneratePhpIni("/output/php.ini");
```

## Supported Platforms

### Apache Detection
- **Windows:** C:\Apache, D:\Apache, E:\Apache, C:\Apache24, XAMPP
- **Linux:** /etc/apache2, /etc/httpd, /opt/apache2
- **macOS:** /usr/local/apache2

### PHP Detection
- **Windows:** C:\php, D:\php, E:\php, C:\xampp\php
- **Linux:** /usr/bin/php, /usr/local/bin/php
- **macOS:** /usr/local/bin/php

## Troubleshooting

### Apache Not Found
If Apache is installed but not detected, check:
1. Apache is in one of the standard locations
2. httpd.exe (Windows) or httpd (Linux) is executable
3. Apache version is 2.4+

### PHP Not Found
If PHP is installed but not detected:
1. Add PHP to system PATH
2. Install in a standard location (C:\php, /usr/bin/php)
3. Verify PHP 8+ is installed

### Reverse Proxy Not Working
1. Verify Apache modules are loaded (check console output)
2. Restart Apache after configuration
3. Check Apache error logs for details
4. Verify RaCore is running on configured port

## Examples

### Complete Setup Script (Windows)
```csharp
// 1. Verify Apache
var apachePath = ApacheManager.FindApacheExecutable();
if (apachePath == null)
{
    Console.WriteLine("Apache not found. Install Apache 2.4+");
    return;
}

// 2. Verify PHP
var phpPath = ApacheManager.FindPhpExecutable();
if (phpPath == null)
{
    Console.WriteLine("PHP not found. Install PHP 8+");
    return;
}

// 3. Configure reverse proxy
var manager = new ApacheManager("/cms/path", 8080);
var success = manager.ConfigureReverseProxy(5000, "localhost");
if (success)
{
    Console.WriteLine("Reverse proxy configured!");
    Console.WriteLine("Restart Apache to apply changes.");
}
```

### Check System Health
```csharp
var bootSequence = new BootSequenceManager(moduleManager);
bool success = await bootSequence.ExecuteBootSequenceAsync();
if (!success)
{
    Console.WriteLine("Boot sequence completed with warnings");
}
```

## Security Notes

1. **Backup:** Apache configuration is automatically backed up before modification
2. **Permissions:** Modifying httpd.conf may require administrator privileges
3. **Testing:** Test configuration with `httpd -t` before restarting Apache
4. **Monitoring:** Check Apache error logs after configuration changes

## Future Enhancements

Planned features:
- Auto-configuration on Linux (currently Windows-only)
- SSL/TLS certificate management
- Multiple domain/port configurations
- Advanced proxy rules (load balancing, caching)
- PHP-FPM configuration
- Database server detection and configuration
