# Boot Sequence and Configuration Management

## Overview
RaCore now includes an advanced boot sequence that performs automatic health checks, configuration verification, and self-healing on every startup.

## ⚠️ Important: External Dependencies

**Nginx and PHP are EXTERNAL dependencies** that must be installed and managed separately from RaOS:

- **RaOS CONFIGURES** Nginx/PHP but does NOT start, stop, or restart them
- **You must manually install** Nginx and PHP on your system
- **You must manually start/restart** Nginx and PHP after RaOS configures them
- RaOS will generate configuration files and provide clear instructions

**Why this design?**
- Allows you to use your preferred versions of Nginx and PHP
- Prevents conflicts with existing web server installations
- Gives you full control over web server lifecycle management
- Enables easy upgrades of Nginx/PHP without RaOS involvement

## Boot Sequence Features

### 1. Self-Healing Health Checks
On every startup, RaCore:
- Runs health checks on all loaded modules
- Identifies healthy, degraded, and unhealthy modules
- Automatically attempts recovery for degraded/unhealthy modules
- Reports results to the console

**Example Output:**
```
[BootSequence] Step 1/3: Running self-healing health checks...
✅ Health check complete:
   Healthy: 34
   ⚠️  Degraded: 1
[BootSequence] Attempting auto-recovery...
   AILanguage: ✅ Recovered
```

### 2. Nginx Configuration Management

#### Automatic Configuration on Boot
**NEW:** RaCore now automatically configures Nginx reverse proxy during boot sequence when Nginx is detected!

**IMPORTANT:** RaCore only CONFIGURES Nginx, it does not START or RESTART it. You must manually start/restart Nginx after RaCore configures it.

On every startup, RaCore:
- Detects Nginx installation (Windows, Linux, macOS)
- Locates nginx.conf configuration file
- Checks if RaCore reverse proxy is already configured
- **Automatically configures reverse proxy** if not present
- **Automatically includes server names for agpstudios.online and www.agpstudios.online**
- Creates backup of nginx.conf before modifications
- Reports detailed status and instructions
- **Provides clear instructions to manually start/restart Nginx**

**No environment variables required!** Simply launch RaOS.exe and Nginx will be configured automatically to accept traffic from localhost, agpstudios.online, and www.agpstudios.online.

**You must then manually start or restart Nginx** for the changes to take effect:
- Windows: `cd C:\nginx && start nginx` (or `nginx -s reload` if already running)
- Linux/Mac: `sudo systemctl start nginx` (or `sudo systemctl reload nginx` if already running)

#### How It Works
1. **Nginx Detection**: Boot sequence finds Nginx executable and config file
2. **Configuration Check**: Verifies if RaCore reverse proxy is already set up
3. **Auto-Configuration**: If not configured:
   - Adds server block configuration for port 80
   - Adds server names for localhost, agpstudios.online, and www.agpstudios.online
   - Configures WebSocket support
   - Creates timestamped backup of nginx.conf
   - **Displays instructions to manually start/restart Nginx**
4. **Manual Nginx Start**: You must start/restart Nginx manually
5. **Access**: After starting Nginx, access RaCore at:
   - http://localhost
   - http://agpstudios.online
   - http://www.agpstudios.online

#### Customization (Optional)
You can customize the domain using environment variables:
- `RACORE_PORT=80` - RaCore server port (default: 80)
- `RACORE_PROXY_DOMAIN=yourdomain.com` - Custom domain (default: localhost)

**Example (Windows):**
```batch
set RACORE_PROXY_DOMAIN=example.com
RaOS.exe
```

**Example (Linux/macOS):**
```bash
export RACORE_PROXY_DOMAIN=example.com
./RaCore
```

#### Reverse Proxy Configuration
Nginx reverse proxy configuration for RaCore:

**Features:**
- Auto-detects Nginx installation path (Windows, Linux, macOS)
- Finds nginx.conf configuration file automatically
- Adds server block with reverse proxy configuration
- Supports WebSocket proxying for /ws endpoint
- Creates automatic backup before modifying config
- Supports custom domains and ports
- **Detailed error reporting** with troubleshooting steps

**Generated Configuration:**
```nginx
# RaCore Reverse Proxy Configuration
# Auto-generated by RaCore NginxManager on 2024-01-01 12:00:00 UTC
# This configuration allows accessing RaCore at http://localhost (port 80)
# instead of http://localhost:80 (same port, but through Nginx)
server {
    listen 80;
    server_name localhost agpstudios.online www.agpstudios.online;
    
    location / {
        proxy_pass http://localhost:80;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
    
    # WebSocket support
    location /ws {
        proxy_pass http://localhost:80/ws;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
    }
    
    access_log logs/racore_proxy_access.log;
    error_log logs/racore_proxy_error.log;
}
```

#### Using the Configuration
After automatic configuration, **Nginx is reloaded automatically by RaOS**. No manual intervention needed!

If automatic reload fails (e.g., due to permissions), manually reload Nginx:
- **Windows**: `nginx -s reload` from Nginx directory
- **Linux**: `sudo systemctl reload nginx` or `sudo nginx -s reload`
- **macOS**: `sudo nginx -s reload` or `brew services reload nginx`

After reload (automatic or manual), access RaCore at:
- **Standard URL**: http://localhost (port 80)
- **Production domain**: http://agpstudios.online (port 80)
- **www subdomain**: http://www.agpstudios.online (port 80)
- **Direct access**: http://localhost:80 (same as standard URL)

#### Troubleshooting
If automatic configuration fails:
1. **Permission denied**: Run RaCore as Administrator (Windows) or with sudo (Linux/macOS)
2. **Nginx not found**: Install Nginx and ensure it's in PATH
3. **Config file not found**: Check Nginx installation directory
4. **Manual configuration**: See error message for manual config steps
5. **Reload failed**: Manually reload Nginx using commands above

### 3. PHP Configuration Management

#### Detection and Verification
RaCore automatically detects PHP installation:
- Searches common installation paths (C:\php, E:\php, /usr/bin/php, etc.)
- Verifies PHP version (PHP 8+ recommended)
- Locates php.ini configuration file
- Reports status on every boot

#### Static Methods Available

**Find PHP Executable:**
```csharp
string? phpPath = ApacheManager.FindPhpExecutable();
if (phpPath != null)
{
    Console.WriteLine($"PHP found at: {phpPath}");
}
```

**Find php.ini Configuration:**
```csharp
string? phpIniPath = ApacheManager.FindPhpIniPath();
if (phpIniPath != null)
{
    Console.WriteLine($"PHP config at: {phpIniPath}");
}
```

**Generate php.ini:**
```csharp
bool success = ApacheManager.GeneratePhpIni("/path/to/php.ini");
```

Generated php.ini includes:
- Recommended PHP settings for RaCore
- Error logging configuration
- Upload and post size limits
- SQLite3 support
- UTC timezone
- Security settings

## Boot Sequence Flow

```
1. Module Loading
   ↓
2. Boot Sequence Execution
   ├─ Self-Healing Health Checks
   │  ├─ Check all modules
   │  ├─ Identify issues
   │  └─ Attempt auto-recovery
   ├─ Nginx Configuration Verification & Auto-Config
   │  ├─ Detect Nginx
   │  ├─ Find nginx.conf
   │  ├─ Check if RaCore proxy configured
   │  └─ Auto-configure if needed
   └─ PHP Configuration Verification
      ├─ Detect PHP
      ├─ Get version
      └─ Find php.ini
   ↓
3. First Run Check (if needed)
   ├─ Generate wwwroot files
   ├─ Spawn CMS
   └─ Configure Nginx for CMS
   ↓
4. Server Startup
```

## Configuration API

### Environment Variables

**Nginx Reverse Proxy Configuration:**
Nginx reverse proxy is **now automatically configured** during boot sequence when Nginx is detected!

**Optional customization** (environment variables):
- `RACORE_PROXY_DOMAIN=yourdomain.com` - Set custom domain (default: localhost)
- `RACORE_PORT=80` - RaCore server port (default: 80)

**Example (Windows):**
```batch
set RACORE_PROXY_DOMAIN=example.com
set RACORE_PORT=80
RaOS.exe
```

**Example (Linux/macOS):**
```bash
export RACORE_PROXY_DOMAIN=example.com
export RACORE_PORT=80
./RaCore
```

### Nginx Configuration
```csharp
// Find Nginx
string? nginxPath = NginxManager.FindNginxExecutable();
string? configPath = NginxManager.FindNginxConfigPath();

// Configure reverse proxy
var manager = new NginxManager("/cms/path", 8080);
bool success = manager.ConfigureReverseProxy(80, "example.com");
```

### PHP Configuration
```csharp
// Find PHP
string? phpPath = NginxManager.FindPhpExecutable();
string? phpIni = NginxManager.FindPhpIniPath(phpPath);

// Generate php.ini
bool success = NginxManager.GeneratePhpIni("/output/php.ini");
```

## Supported Platforms

### Nginx Detection
- **Windows:** C:\nginx, C:\nginx-1.24.0, C:\nginx-1.25.0
- **Linux:** /usr/sbin/nginx, /etc/nginx, /usr/local/nginx
- **macOS:** /usr/local/sbin/nginx, /usr/local/etc/nginx

### PHP Detection
- **Windows:** C:\php, D:\php, E:\php, C:\xampp\php
- **Linux:** /usr/bin/php, /usr/local/bin/php
- **macOS:** /usr/local/bin/php

## Troubleshooting

### Nginx Not Found
If Nginx is installed but not detected, check:
1. Nginx is in one of the standard locations
2. nginx.exe (Windows) or nginx (Linux/macOS) is executable
3. Nginx is in system PATH

### Nginx Not Starting
**RaCore does NOT start Nginx automatically.** You must manually start Nginx:

**Windows:**
```batch
cd C:\nginx
start nginx
```
Or to reload if already running:
```batch
nginx -s reload
```

**Linux:**
```bash
sudo systemctl start nginx
# Or to reload if already running:
sudo systemctl reload nginx
```

**macOS:**
```bash
brew services start nginx
# Or to reload if already running:
nginx -s reload
```

### PHP Not Found
If PHP is installed but not detected:
1. Add PHP to system PATH
2. Install in a standard location (C:\php, /usr/bin/php)
3. Verify PHP 8+ is installed

### PHP Not Starting for CMS
**RaCore does NOT start PHP automatically.** You must manually start PHP or PHP-FPM:

**Option 1: PHP Built-in Server (for testing):**
```bash
cd /path/to/wwwroot
php -S localhost:8080
```

**Option 2: PHP-FPM with Nginx (recommended for production):**
```bash
# Linux
sudo systemctl start php-fpm
sudo systemctl start nginx

# macOS
brew services start php
brew services start nginx
```

### Reverse Proxy Not Working
1. Verify Nginx configuration with `nginx -t`
2. **Manually start or reload Nginx** after RaCore configures it
3. Check Nginx error logs for details
4. Verify RaCore is running on configured port
5. Ensure Nginx and RaCore are not using conflicting ports

## Examples

### Complete Setup Script (Windows)
```csharp
// 1. Verify Nginx
var nginxPath = NginxManager.FindNginxExecutable();
if (nginxPath == null)
{
    Console.WriteLine("Nginx not found. Install Nginx");
    return;
}

// 2. Verify PHP
var phpPath = NginxManager.FindPhpExecutable();
if (phpPath == null)
{
    Console.WriteLine("PHP not found. Install PHP 8+");
    return;
}

// 3. Configure reverse proxy
var manager = new NginxManager("/cms/path", 8080);
var success = manager.ConfigureReverseProxy(80, "localhost");
if (success)
{
    Console.WriteLine("Reverse proxy configured!");
    Console.WriteLine("Reload Nginx to apply changes.");
}
```

### Check System Health
```csharp
var bootSequence = new BootSequenceManager(moduleManager);
bool success = await bootSequence.ExecuteBootSequenceAsync();
if (!success)
{
    Console.WriteLine("Boot sequence completed with warnings");
}
```

## Security Notes

1. **Backup:** Apache configuration is automatically backed up before modification
2. **Permissions:** Modifying httpd.conf may require administrator privileges
3. **Testing:** Test configuration with `httpd -t` before restarting Apache
4. **Monitoring:** Check Apache error logs after configuration changes

## Future Enhancements

Planned features:
- Auto-configuration on Linux (currently Windows-only)
- SSL/TLS certificate management
- Multiple domain/port configurations
- Advanced proxy rules (load balancing, caching)
- PHP-FPM configuration
- Database server detection and configuration
